# Pass 5: Flutter CI/CD Pipeline
# Builds, tests, and deploys the Flutter mobile app

name: Flutter CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - 'android/**'
      - 'ios/**'
      - '.github/workflows/flutter-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # =====================================================
  # JOB 1: ANALYZE & TEST
  # =====================================================
  analyze-and-test:
    name: ğŸ” Analyze & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: false

      - name: ğŸ§ª Run tests
        run: flutter test --coverage
        continue-on-error: true

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false

  # =====================================================
  # JOB 2: BUILD ANDROID APK
  # =====================================================
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build APK (Release)
        run: |
          flutter build apk --release \
            --dart-define=ENVIRONMENT=production \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sparelink-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 14

      - name: ğŸ“¤ Upload App Bundle
        run: |
          flutter build appbundle --release \
            --dart-define=ENVIRONMENT=production \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

      - name: ğŸ“¤ Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: sparelink-release-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 14

  # =====================================================
  # JOB 3: BUILD WEB (Flutter Web)
  # =====================================================
  build-web:
    name: ğŸŒ Build Web
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Web (Release)
        run: |
          flutter build web --release \
            --dart-define=ENVIRONMENT=production \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

      - name: ğŸ“¤ Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: sparelink-web
          path: build/web
          retention-days: 14

  # =====================================================
  # JOB 4: NOTIFY ON FAILURE
  # =====================================================
  notify-failure:
    name: ğŸš¨ Notify on Failure
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-android, build-web]
    if: failure()
    
    steps:
      - name: ğŸ“§ Send failure notification
        run: |
          echo "ğŸš¨ Flutter CI/CD Pipeline Failed!"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          # Add Slack/Discord webhook here if needed
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš¨ SpareLink Flutter build failed on ${{ github.ref }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
